# git開発とかCNCF TrailMap以前のレガシーを何とかする
unsafeな運用になっている本番環境をどうするか。

- 本番稼働中のサーバーだけが存在 (テスト環境などはない)
- バックアップが無い
- 変更方法は本番サーバーへの直接のファイル変更 (という運用になっている)
- データやログが外だしされておらず、各サーバーがステートフル
- 履歴は自動では取られていない

## 1. 判断
- リロケート
- リホスト
- リプラットフォーム
- リファクタリング
- リパーチェス
- リテイン
- リタイヤ

https://www.nri.com/jp/knowledge/blog/lst/2023/iis/dx_implementation/0510_1

### 1.1. 手を入れなければいけない圧力

- セキュリティ → データの消失と流出
- 障害対策 → 下記のTrailMapができてないほど、本番環境のダウンから復旧までが遅い
- 機能追加

逆に言えば、それらがない場合、むやみに手を入れてはいけない。

### 1.2. 運用レベルのテクニック

- 途中でリタイヤ … 今この瞬間に全て捨ててリタイヤはできないとしたら、何をしたらリタイアできるか？
- 部分リタイヤ … システムを今後要素分解出来た暁に、部分的にリタイアできるところはあるか？
- 並走パターン … 本番環境への変更は従来通りのunsafeな方法を維持するが、よりよい体制のシステム (より更新容易なシステム) を横に立ち上げ、並走しばらく並走する。

## 2. TrailMap
現時点でリタイア・リテインができないことが分かった時に、初めて開発を進める。
変更要求は自発的、セキュリティや障害は他発的 = 制御不能なので、後者による問題からの復旧の方が大事。

### 2.1. 複製 (バックアップ)
定期的にバックアップが取られていて、本番環境に対するデータやシステムの更新が別の場所に記録されている。

- 本番環境がハードウェア故障などで完全にロストしても、復旧の可能性が絶たれない (復旧できるとは言っていない)。


### 2.2. 複製システムの立ち上げ
本番環境と極力同じものを作成し、**一時的に動作させられる**。定期的なバックアップからのリストアの方法が明らかになっている。
この時点では本番環境の素性はブラックボックスのまま。

- 本番環境がハードウェア故障などで完全にロスト場合に、最終バックアップから復旧できることが保証される。
- この時点ではまだ機能追加などの更新を作業を行うことは基本的に不可能。

#### 2.2.1. バックアップから複製できる
- VMのスナップショットが取られており、そこから復元する形でサーバーの複製が作れる
- ネットワークの設定方法やバックアップストレージのリストア方法がドキュメント化されており、それに従い構築を進めることで、システム全体が稼働する

#### 2.2.2. 稼働中の本番環境が故障した時に、複製を用いて業務を継続できる


### 2.3. staging環境の作成
本番と極力同じで、かつ**常駐し開発部隊が検証に使える**環境を作成・維持できる。要は、上記から、本番環境と同じではいけないところの差分をコントロールする術を獲得した状態。
さらに具体的に言えば、システム外への副作用が適切に遮断されている。

- 定期的にメールを送信する機能がある場合に、本番環境を複製するとユーザーには2通メールが届いてしまう。メールモジュールをモック的なものに置き換え、外部に実際に送信しないような仕組みになっていたりの対応が必要 (登録メールアドレスを偽物に置き換えたデータベースをすぐに作れる、というような実装でもよい)
- cron等で外部に何か処理を引き起こすなども同様に無効化などする。

アンチパターン
- 再作成できないstaging環境 … 開発や運用を経てどんどん構成ドリフトやデータドリフトが発生し、検証に使える状態ではなくなる


### 2.4. リグレッションテスト
ある変更を行う際に、既存機能が従来通り動くことを確認する手段がある。

- テスト手順が明文化されていて、staging環境を使い、手動でリグレッションテストができる
- 何らかのスクリプト等で、リグレッションテストの実施コストが下げられている


### 2.5. 更新履歴の記録
- 使うプログラムのソースコードとビルド方法をgitに入れる
- デプロイの手順やIaCコードをgitに入れる
- データベースの (開発環境用の) 初期データ、またはその生成方法をgitに入れる

#### 2.5.1. 履歴管理対象のファイルが明らかになっている
gitに入っているものが必要十分であり、

- /から全ファイルが管理されているわけではない
- package-lock.json的な状態 (ミドルウェアを入れるなら、そのaptパッケージ群と/etc以下の設定など、ベースイメージからの差分として管理されている

現状の本番環境にgitからデプロイしようとしてはいけない。この時点での本番環境は「ゼロから構築」がまだできないはずであり、ミスに対して何もリカバリー手段がない。
従って、本番環境への

#### 2.5.2. 実際にファイルを収集し、git addする


### 2.6. ソースリポジトリからの構築
gitからデプロイができる。

ここではじめて、gitをSSOTとし、gitから本番環境を手作業で構築できるようになる。しばらく並走する。

以降は、更新を楽にするためのあらゆる施策 = CNCF TrailMap

### 2.7. ステートの集約 → イミュータブルインフラ
- データとログ (=ステート) が何らかのストレージサーバーに集約されることで、コンピューティング系のインスタンスはステートレスになり、インスタンスをいつ潰して再作成しても良いようになる
- ソースリポジトリからの構築ができることと組み合わせて、ステートレスインスタンスのフルバックアップは不要になる

### 2.8. コンテナ (ゴールデンイメージ)
一度構築して、流し込むことでデプロイを容易化する仕組みがあることで、デプロイ時間が短縮される

### 2.9. CI/CD, ...
変更時の作業が自動化されていて、デプロイ頻度が上げられる

## 3. テクニック
Strangler Pattern
