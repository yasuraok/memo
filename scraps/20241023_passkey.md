# PasskeyとBitWarden

iPhoneとは別にAndroidタブレットを買ったので、TOTPによる2FAを2台体制にしたいが、それとは別にPasskeyに対応してるアプリは移行したい。
BitWardenでPasskeyが使えるようになりつつある。が、これが2FA相当になるのか即答できなかったので調査。

https://bitwarden.com/ja-jp/blog/bitwarden-launches-passkey-management/

## 1. パスワードレスとは
- パスワード = 通信経路上を半永久的に有効な秘密情報そのものが通る (ので、盗聴の危険が多い)
- チャレンジレスポンス = 公開鍵暗号方式で、認証中に通信経路上を通るデータは秘密情報そのものではない

パスワードレスという言葉 (だけ) の要件としてはチャレンジレスポンスを使うということらしい。
サーバーレスと一緒で名前が悪いと思っている (秘密鍵を所有して管理しないといけない訳で。逆に「パスワード」の定義が狭すぎるのかも)。というかパスキーという言葉もパスワードと何がちがうの？という感じで名前が悪いと思う…。

## 2. Passkeyとは
- 狭義: チャレンジレスポンス方式 + キーのマルチデバイス (クラウド) 管理 (+2FA)
- 広義: 上記 + キーの OS/HSM/スマホ等での管理 (+2FA)

https://zenn.dev/koduki/articles/061998796e0d33#passkey

## 3. 2FAたる所以はキーの取り出し方
キーにアクセスするための条件として所有要素や生態要素を使うことで、(パスワードは使わないまま) 2FA相当になる。

- クラウド/OS/HSM/スマホ 等にキーを保存し、そのアクセスをローカルの生体認証で保護する。
- クラウド/OS/HSM/スマホ 等にキーを保存し、そのアクセスをPINコードで保護する。
  ここでいうPINとは、秘密情報にアクセスするために **そのデバイス内で** 使われる代わりの文字列のこと (そうでない定義のPINコードもあるようだが)。
  通信経路上を通らないので、上記におけるパスワードとは性質が異なる。
  例えばBitWardenでマスターパスワードの代わりにPINコードを設定するのは、後者は端末ごとの独立設定となっている (2台のアプリそれぞれで別のPINコードを設定できる)。
  ssh秘密鍵のパスフレーズに似ていると思う。

## 4. 移行
### 4.1. TOTP2台
スマホ + デスクトップの2台でTOTPを使えるようにしたくてAuthyにまとめていたが、(1) Authyがデスクトップアプリをやめた、(2) QRコードを読み取るタイミングで複数台で読み取ればやりたいことはできる、ということで、Authyはtoo muchと考え止めることにする。

BitWardenからもAuthenticatorが出ていた。これはすべて端末内で完結する構成のようなので、上記の方法と組み合わせてTOTP2台を再設定できそう。

### 4.2. BitWarden自体のログインにPasskeyを使う → 保留

現時点ではブラウザログイン時のみしかPasskeyを使えないらしい。あんまり意味がないので設定がシンプルな方がいいということでやめる。

### 4.3. BitWarden内に登録しているサービスのログインにPasskeyを使う → 保留

使うこと自体はすんなりできる。googleやGitHubで試すと、それまでパスワード+何かの2FAだったものが、PasskeyにするとPasskeyだけでログインできるようになってしまう。Windows OS自体にPasskeyを保存するとそのアクセスの際に生体認証が都度要求されるが、BitWardenにPasskeyを入れた場合、呼び出す際に特にPINや生体認証が要求されない。従って、「BitWarden保管庫のタイムアウトをものすごく短くして、かつアンロックに常に2FAを要求する」設定にしていないかぎりは実質2FAにならないことになってしまう。

タイムアウトを短くする場合は生体認証を使いたいが、手元のWindows PC + BitWardenブラウザ拡張では今時点ではどうもきちんと動いてくれなかったので、ブラウザ拡張は最低でもPIN入力が必要。この場合タイムアウトはある程度長くせざるを得ないので、デスクトップがマルウェア感染しているみたいなケースも考えると今Passkey化するのはちょっと心配。
